{% extends 'base.html' %}
{% block title %}Dashboard - Service Desk{% endblock %}
{% block content %}

<div class="dashboard-header">
    <h1 class="dashboard-title">Tickets Groovoo</h1>
</div>

<div class="filters">
    <form method="get" action="{{ url_for('dashboard') }}" class="filter-form">
        <input type="text" name="q" placeholder="Buscar no título, cliente..." value="{{ query or '' }}" class="filter-input">
        
        <select name="category" class="filter-select">
            <option value="">Todas as categorias</option>
            {% for category in categories %}
            <option value="{{ category }}" {% if category == category_filter %}selected{% endif %}>{{ category }}</option>
            {% endfor %}
        </select>

        <select name="tag" class="filter-select">
            <option value="">Todas as tags</option>
            {% for tag in all_tags %}
            <option value="{{ tag }}" {% if tag == tag_filter %}selected{% endif %}>{{ tag }}</option>
            {% endfor %}
        </select>
        
        <button type="submit" class="btn btn-primary">Filtrar</button>
    </form>
    <div class="action-buttons">
        <button class="btn btn-primary" onclick="openModal()">Novo Ticket</button>
        <a href="{{ url_for('archived_tickets') }}" class="btn btn-secondary">Ver Arquivados</a>
        <a href="{{ url_for('export_csv') }}" class="btn btn-secondary">Exportar CSV</a>
        <a href="{{ url_for('export_markdown') }}" class="btn btn-secondary">Exportar MD</a>
    </div>
</div>

<div class="status-counters">
    <div class="counter-card">
        <h4>Abertos</h4>
        <p>{{ statuses.get('Aberto', 0) }}</p>
    </div>
    <div class="counter-card">
        <h4>Aguardando</h4>
        <p>{{ statuses.get('Aguardando', 0) }}</p>
    </div>
    <div class="counter-card">
        <h4>Resolvidos</h4>
        <p>{{ statuses.get('Resolvido', 0) }}</p>
    </div>
    <div class="counter-card">
        <h4>Fechados</h4>
        <p>{{ statuses.get('Fechado', 0) }}</p>
    </div>
</div>

<div class="cards-container">
  {% if tickets %}
     {% for ticket in tickets %}
    <div class="ticket-card card-border-{{ ticket.status | lower }}">
      
      <a href="{{ url_for('ticket_detail', ticket_id=ticket.id) }}" class="ticket-link">
        <div class="card-header">
          <h3 class="card-title">{{ ticket.title }}</h3>
          <div class="badges">
              <span class="priority-badge priority-{{ ticket.priority | lower }}">{{ ticket.priority }}</span>
              <span class="status-badge status-{{ ticket.status | lower }}">{{ ticket.status }}</span>
          </div>
        </div>
        <div class="card-body">
          <p><strong>Cliente:</strong> {{ ticket.client_name }}</p>
          <p class="description">{{ ticket.description[:120] }}{% if ticket.description|length > 120 %}…{% endif %}</p>
        </div>
      </a>

      <div class="card-footer">
        <span class="timestamp">Atualizado em: {{ ticket.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
        <div class="card-actions">
          <form action="{{ url_for('archive_ticket', ticket_id=ticket.id) }}" method="post" style="margin: 0;">
            <button type="submit" class="icon-btn" title="Arquivar Ticket">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 3h18v4H3V3m18 6v12H3V9h18M5 11v2h8v-2H5z"/></svg>
            </button>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  {% else %}
    <div class="no-tickets" style="text-align: center; padding: 2rem;">
      <p>Nenhum ticket encontrado.</p>
      <button class="btn btn-primary" onclick="openModal()">Criar o primeiro ticket</button>
    </div>
  {% endif %}
</div>

<div id="newTicketModal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Criar Novo Ticket</h2>
      <button class="close-modal-btn" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form action="{{ url_for('create_ticket') }}" method="post" enctype="multipart/form-data" novalidate>
        
        <div class="form-group">
          <label for="title">Título *</label>
          <input type="text" id="title" name="title" required>
        </div>

        <div class="form-group">
          <label for="description">Descrição Detalhada *</label>
          <textarea id="description" name="description" required rows="4"></textarea>
        </div>

        <div class="form-group">
          <label for="priority">Prioridade</label>
          <select id="priority" name="priority">
              <option value="Low">Baixa</option>
              <option value="Medium">Média</option>
              <option value="High">Alta</option>
          </select>
        </div>

        <div class="form-group">
          <label for="category">Categoria do Problema *</label>
          <select id="category" name="category" required>
              <option value="" disabled selected>Selecione uma categoria</option>
              <option value="Problema com Pagamento">Problema com Pagamento</option>
              <option value="Problema com Ordem">Problema com Ordem</option>
              <option value="Erro no App">Erro no App</option>
              <option value="Dúvida sobre Evento">Dúvida sobre Evento</option>
              <option value="Login/Senha">Login/Senha</option>
              <option value="Autorização de Dispositivo">Autorização de Dispositivo</option>
          </select>
        </div>

        <div class="form-group">
          <label for="channel">Canal de Atendimento *</label>
          <select id="channel" name="channel" required>
              <option value="" disabled selected>Selecione um canal</option>
              <option value="WhatsApp">WhatsApp</option>
              <option value="Ligação">Ligação</option>
              <option value="Email">Email</option>
              <option value="Mensagem">Mensagem</option>
          </select>
        </div>

        <hr style="border: none; border-top: 1px solid var(--border-color); margin: 2rem 0;">

        <div class="form-group">
          <label for="client_name">Nome do Cliente *</label>
          <input type="text" id="client_name" name="client_name" required>
        </div>
        <div class="form-group">
          <label for="client_contact">Contacto do Cliente *</label>
          <input type="text" id="client_contact" name="client_contact" required>
        </div>
        <div class="form-group">
          <label for="email">E-mail</label>
          <input type="email" id="email" name="email">
        </div>
        <div class="form-group">
          <label for="telefone">Telefone</label>
          <input type="tel" id="telefone" name="telefone">
        </div>
        <div class="form-group">
          <label for="tags">Tags (separadas por vírgula)</label>
          <input type="text" id="tags" name="tags">
        </div>
        <div class="form-group">
          <label for="organizer">Organizer</label>
          <input type="text" id="organizer" name="organizer">
        </div>
        <div class="form-group">
          <label for="event">Event</label>
          <input type="text" id="event" name="event">
        </div>

        <div class="form-group">
            <label for="attachments">Anexos (imagem ou PDF)</label>
            <input type="file" id="attachments" name="attachments" multiple>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
            <button type="submit" class="btn btn-primary">Criar Ticket</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}