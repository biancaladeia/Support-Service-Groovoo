{% extends 'base.html' %}
{% block title %}Dashboard - Service Desk{% endblock %}
{% block content %}

<div class="dashboard-header">
    <h1 class="dashboard-title">Tickets Groovoo</h1>
</div>

<div class="filters">
    <form method="get" action="{{ url_for('dashboard') }}" class="filter-form">
        <input type="text" name="q" placeholder="Buscar no título, cliente..." value="{{ query or '' }}" class="filter-input">
        <select name="category" class="filter-select">
            <option value="">Todas as categorias</option>
            {% for category in categories %}
            <option value="{{ category }}" {% if category == category_filter %}selected{% endif %}>{{ category }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary">Filtrar</button>
    </form>
    <div class="action-buttons">
        <a href="{{ url_for('create_ticket') }}" class="btn btn-primary">Novo Ticket</a>
        <a href="{{ url_for('export_csv') }}" class="btn btn-secondary">Exportar CSV</a>
        <a href="{{ url_for('export_markdown') }}" class="btn btn-secondary">Exportar MD</a>
    </div>
</div>

<div class="status-counters">
    <div class="counter-card">
        <h4>Abertos</h4>
        <p>{{ statuses.get('Aberto', 0) }}</p>
    </div>
    <div class="counter-card">
        <h4>Aguardando</h4>
        <p>{{ statuses.get('Aguardando', 0) }}</p>
    </div>
    <div class="counter-card">
        <h4>Resolvidos</h4>
        <p>{{ statuses.get('Resolvido', 0) }}</p>
    </div>
    <div class="counter-card">
        <h4>Fechados</h4>
        <p>{{ statuses.get('Fechado', 0) }}</p>
    </div>
</div>

<div class="cards-container">
  {% if tickets %}
    {% for ticket in tickets %}
    <div class="ticket-card">
      <div class="card-header">
        <h3 class="card-title">{{ ticket.title }}</h3>
        <div class="badges">
            <span class="priority-badge priority-{{ ticket.priority | lower }}">{{ ticket.priority }}</span>
            <span class="status-badge status-{{ ticket.status | lower }}">{{ ticket.status }}</span>
        </div>
      </div>
      <div class="card-body">
        <p><strong>Cliente:</strong> {{ ticket.client_name }}</p>
        <p class="description">{{ ticket.description[:120] }}{% if ticket.description|length > 120 %}…{% endif %}</p>
      </div>
      <div class="card-footer">
        <span class="timestamp">Atualizado em: {{ ticket.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
        <div class="card-actions">
          <a href="{{ url_for('ticket_detail', ticket_id=ticket.id) }}" class="btn-link">Detalhes</a>
          <form action="{{ url_for('archive_ticket', ticket_id=ticket.id) }}" method="post" style="margin: 0;">
            <button type="submit" class="btn btn-secondary">Arquivar</button>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  {% else %}
    <div class="no-tickets">
      <p>Nenhum ticket encontrado.</p>
      <a href="{{ url_for('create_ticket') }}" class="btn btn-primary">Criar o primeiro ticket</a>
    </div>
  {% endif %}
</div>

{% endblock %}